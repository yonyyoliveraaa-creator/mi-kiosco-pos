<!DOCTYPE html>
<html>
<head>
    <title>Punto de Venta - Mi Kiosco</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; gap: 20px; padding: 20px; background: #eef2f3; margin: 0; }
        .seccion { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .lista-venta { flex: 2; min-height: 80vh; }
        .total-caja { flex: 1; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border-bottom: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; }
        .total-numero { font-size: 60px; color: #2ecc71; font-weight: bold; margin: 20px 0; }
        #codigo-scanner { width: 100%; padding: 15px; font-size: 20px; border: 2px solid #3498db; border-radius: 5px; box-sizing: border-box; }
        .btn-finalizar { width: 100%; padding: 25px; background: #2ecc71; color: white; border: none; border-radius: 10px; font-size: 24px; cursor: pointer; font-weight: bold; }
        .btn-finalizar:hover { background: #27ae60; }
    </style>
</head>
<body>

<div class="seccion lista-venta">
    <h2>ðŸ›’ Carrito de Venta</h2>
    <input type="text" id="codigo-scanner" placeholder="Escanee producto aquÃ­ o use el celular..." autofocus>
    
    <table id="tabla-ventas">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Precio</th>
                <th>Cant.</th>
                <th>Subtotal</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
</div>

<div class="seccion total-caja">
    <h2>TOTAL A COBRAR</h2>
    <div class="total-numero" id="monto-total">$0</div>
    <button class="btn-finalizar" onclick="finalizarVenta()">FINALIZAR VENTA</button>
</div>

<script>
    // --- CONFIGURACIÃ“N DE TU SUPABASE ---
    const SUPABASE_URL = 'https://ovctgqmhumlspklhbjhf.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92Y3RncW1odW1sc3BrbGhiamhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMTcyOTEsImV4cCI6MjA4Mzc5MzI5MX0.6PrQwbYrjDZqo_Zku3uM-z7Bt3-Dn59cMbl5l9KAo_Q';
    const clienteSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let carrito = [];
    let total = 0;

    // 1. ESCUCHAR AL TECLADO / ESCÃNER FÃSICO
    const inputScanner = document.getElementById('codigo-scanner');
    inputScanner.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
            const codigo = inputScanner.value;
            inputScanner.value = ''; 
            buscarYAgregar(codigo);
        }
    });

    // 2. ESCUCHAR AL CELULAR (MODO REMOTO)
    const canalVentas = clienteSupabase.channel('mostrador')
      .on('broadcast', { event: 'escaneo' }, (payload) => {
        console.log("Recibido desde celular:", payload.payload.codigo);
        buscarYAgregar(payload.payload.codigo);
      })
      .subscribe();

    // 3. FUNCIÃ“N PARA BUSCAR EN LA BASE DE DATOS
    async function buscarYAgregar(codigo) {
        let { data: producto, error } = await clienteSupabase
            .from('productos')
            .select('*')
            .eq('codigo_barra', codigo)
            .single();

        if (producto) {
            // Reproducir sonido de "bip"
            new Audio('https://assets.mixkit.co/active_storage/sfx/2632/2632-preview.mp3').play();
            
            carrito.push(producto);
            actualizarTabla();
        } else {
            console.error("No se encontrÃ³ el producto:", codigo);
            // Sonido de error opcional
        }
    }

    // 4. ACTUALIZAR LA PANTALLA
    function actualizarTabla() {
        const tbody = document.querySelector('#tabla-ventas tbody');
        tbody.innerHTML = '';
        total = 0;

        carrito.forEach((item, index) => {
            total += item.precio_venta;
            tbody.innerHTML += `
                <tr>
                    <td>${item.nombre}</td>
                    <td>$${item.precio_venta}</td>
                    <td>1</td>
                    <td>$${item.precio_venta}</td>
                </tr>
            `;
        });
        document.getElementById('monto-total').innerText = '$' + total;
    }

    // 5. FINALIZAR VENTA Y RESTAR STOCK
    async function finalizarVenta() {
        if (carrito.length === 0) return alert("El carrito estÃ¡ vacÃ­o");

        for (const item of carrito) {
            // Restamos 1 al stock actual del producto
            const nuevoStock = (item.stock || 0) - 1;

            const { error } = await clienteSupabase
                .from('productos')
                .update({ stock: nuevoStock })
                .eq('id', item.id);

            if (error) console.error("Error al actualizar stock de " + item.nombre, error);
        }

        alert("Venta finalizada por $" + total + ". El stock ha sido actualizado.");
        
        // Limpiar todo para la siguiente venta
        carrito = [];
        actualizarTabla();
    }
</script>
</body>
</html>
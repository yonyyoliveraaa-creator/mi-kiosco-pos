<!DOCTYPE html>
<html>
<head>
    <title>Punto de Venta - Mi Kiosco</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; gap: 20px; padding: 20px; background: #111213; }
        .seccion { background: rgb(252, 246, 246); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .lista-venta { flex: 2; }
        .total-caja { flex: 1; text-align: center; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border-bottom: 1px solid #abc9ec; padding: 10px; text-align: left; }
        .total-numero { font-size: 48px; color: #2ecc71; font-weight: bold; }
        #codigo-scanner { width: 100%; padding: 15px; font-size: 20px; border: 2px solid #3498db; border-radius: 5px; }
    </style>
</head>
<body>

<div class="seccion lista-venta">
    <h2>ðŸ›’ Carrito de Venta</h2>
    <input type="text" id="codigo-scanner" placeholder="Escanee producto aquÃ­..." autofocus>
    
    <table id="tabla-ventas">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Precio</th>
                <th>Cant.</th>
                <th>Subtotal</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
</div>

<div class="seccion total-caja">
    <h2>TOTAL</h2>
    <div class="total-numero" id="monto-total">$0</div>
    <br>
    <button onclick="finalizarVenta()" style="width:100%; padding:20px; background:#2ecc71; color:white; border:none; border-radius:10px; font-size:20px; cursor:pointer;">
        FINALIZAR VENTA
    </button>
</div>

<script>
    const SUPABASE_URL = 'https://ovctgqmhumlspklhbjhf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92Y3RncW1odW1sc3BrbGhiamhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMTcyOTEsImV4cCI6MjA4Mzc5MzI5MX0.6PrQwbYrjDZqo_Zku3uM-z7Bt3-Dn59cMbl5l9KAo_Q';
    const clienteSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let carrito = [];
    let total = 0;

    const inputScanner = document.getElementById('codigo-scanner');

    inputScanner.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
            const codigo = inputScanner.value;
            inputScanner.value = ''; // Limpiar para el siguiente
            
            // BUSCAR EN SUPABASE
            let { data: producto, error } = await clienteSupabase
                .from('productos')
                .select('*')
                .eq('codigo_barra', codigo)
                .single();

            if (producto) {
                agregarAlCarrito(producto);
            } else {
                alert("Producto no encontrado. Â¡CÃ¡rgalo primero!");
            }
        }
    });

    function agregarAlCarrito(prod) {
        carrito.push(prod);
        actualizarTabla();
    }

    function actualizarTabla() {
        const tbody = document.querySelector('#tabla-ventas tbody');
        tbody.innerHTML = '';
        total = 0;

        carrito.forEach(item => {
            total += item.precio_venta;
            tbody.innerHTML += `
                <tr>
                    <td>${item.nombre}</td>
                    <td>$${item.precio_venta}</td>
                    <td>1</td>
                    <td>$${item.precio_venta}</td>
                </tr>
            `;
        });
        document.getElementById('monto-total').innerText = '$' + total;
    }

   async function finalizarVenta() {
    for (const item of carrito) {
        // Buscamos el stock actual y le restamos 1
        const nuevoStock = item.stock - 1;

        const { error } = await clienteSupabase
            .from('productos')
            .update({ stock: nuevoStock })
            .eq('id', item.id);

        if (error) console.error("Error al descontar stock:", error);
    }

    alert("Venta realizada y stock actualizado por $" + total);
    carrito = [];
    actualizarTabla();
}
// La PC se une al canal 'mostrador' para escuchar al celular
const canalVentas = clienteSupabase.channel('mostrador')
  .on('broadcast', { event: 'escaneo' }, (payload) => {
    console.log("Recibido desde celular:", payload.payload.codigo);
    // Buscamos el producto automÃ¡ticamente
    buscarYAgregar(payload.payload.codigo); 
  })
  .subscribe();

// FunciÃ³n auxiliar para que el celular use la misma lÃ³gica que el input de teclado
async function buscarYAgregar(codigo) {
   
    
    }
    //OPCIONAL: Reproducir un sonido de "bip" para avisar
     let beep = new Audio('https://assets.mixkit.co/active_storage/sfx/2632/2632-preview.mp3');
    beep.play();
    

    
</script>
</body>
</html>